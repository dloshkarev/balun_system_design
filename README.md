# Проектирование социальной сети для путешественников

---

# Функциональные требования

- создание поста (текстовое описание, гео метка и фотографии)
- добавление реакции на посты
- добавление комментариев к постам (только текст)
- просмотр комментариев к постам
- просмотр списка пользователей
- подписка на других пользователей
- поиск постов по гео метке
- просмотр своей ленты, основанной на подписках в обратном хронологическом порядке
- просмотр ленты других пользователей

---

# Нефункциональные требования

- DAU - 10000000
- География - СНГ
- Предположим, что каждый пользователь:
    - Cоздает новый пост 1 раз в неделю, каждый пост собирает 15 комментариев
    - Пишет 10 комментариев в день
    - Просматривает 50 фотографий из постов в день
    - Читает комментарии к 20 постам в день
    - Подписывается на 1 пользователя в день
    - Просматривает 50 постов 1 раз в неделю в ленте поиска по гео метке
    - Просматривает в своей ленте 50 постов в день
    - Просматривает в ленте других пользователей 25 постов в день в сумме
    - Подписан на 150 человек
    - Имеет 100 подписчиков
    - Ставит лайки 50 постам в день
- Сезонность - 4 месяца в году (летом и в периоды праздников) активность удваивается
- Лимиты:
  - Хранение данных - вечно
  - Максимальное количество фотографий, которое можно приложить к посту = 10
  - Максимальный размер оригинального фото - 3 мб
    - У оригинального фото уменьшаем разрешение до 1920x1440 (пропорционально сторонам) и сжимаем до 80%. На выходе получаем файл размером примерно **1.5 мб**
    - После конвертации в формат для ленты размер уменьшается до **600 кб**
  - Максимальный размер текста - 500 символов (без поддержки эмодзи)
  - Максимальное время загрузки ленты пользователя - 3 сек
  - Максимальное время поиска постов по гео метке - 5 сек
  - Загрузка ленты - по 20 постов в режиме бесконечной ленты
  - Загрузка комментариев - по 20 комментариев в режиме бесконечной ленты
- Доступность: 99.99

### Примерная структура сущностей


**Пост:**

| Поле           | Размер                  |
|:---------------|:------------------------|
| user_id        | 8 байт                  |
| текст          | 1000 байт               |
| latitude       | 8 байт                  |
| longitude      | 8 байт                  |
| ссылки на фото | 10 * 50 байт = 500 байт |
| **Итого**      | 2 Кб                    |


**Фото:**

| Поле      | Размер                    |
|:----------|:--------------------------|
| id        | 8 байт                    |
| url       | 50 байт                   |
| фото      | 1.5 мб (600 кб для ленты) |
| **Итого** | 600 Кб - 1.5 Мб           |


**Комментарий:**

| Поле           | Размер    |
|:---------------|:----------|
| user_id  | 8 байт    |
| post_id | 8 байт    |
| текст | 1000 байт |
| **Итого**     | 1 Кб      |


**Реакция:**

| Поле           | Размер   |
|:---------------|:---------|
| user_id  | 8 байт   |
| post_id | 8 байт   |
| type_id | 4 байт   |
| **Итого**     | 24 байта |

Запись в ленте постов включает:
- Автора
- Текст поста
- **1 фото** (остальные в карусели и подгружаются по запросу)
- Количество лайков
- Количество комментариев (сами комментарии подгружаются отдельно, если провалиться в пост)

---

# Расчет нагрузки требования

Метаинформация для постов:

| Показатель           | Пик                                 | В среднем с учетом сезонности          |
|:---------------|:------------------------------------|:---------------------------------------|
| RPS (write)  | 2 * 10000000 / (7 * 86400) = **33** | 1.33 * 10000000 / (7 * 86400) = **22** |
| RPS (read) | 2 * (50 * 10000000 + 25 * 10000000) / 86400 + 50 * 10000000 / (7 * 864000) = **17526**    | 1.33 * (50 * 10000000 + 25 * 10000000) / 86400 + 50 * 10000000 / (7 * 864000) = **11700**       |
| Traffic (write) | 33 * 2 Кб = **66 Кб/с**             | 22 * 2 Кб = **44 Кб/с**                |
| Traffic (read) | 17526 * 2 Кб = **35 Мб/с**          | 11700 * 2 Кб = **23 Мб/с**             |

Фото внутри поста (оригинальное качество, сохраняем все 10 фото на пост):

| Показатель           | Пик                                       | В среднем с учетом сезонности                |
|:---------------|:------------------------------------------|:---------------------------------------------|
| RPS (write)  | 2 * 10 * 10000000 / (7 * 86400) = **330** | 1.33 * 10 * 10000000 / (7 * 86400) = **220** |
| RPS (read) | 2 * 50 * 10000000 / 86400 = **11574**     | 1.33 * 50 * 10000000 / 86400 = **7697**      |
| Traffic (write) | 330 * 1.5 Мб = **500 Мб/с**               | 220 * 1.5 Мб = **330 Мб/с**                  |
| Traffic (read) | 11574 * 1.5 Мб = **17 Гб/с**              | 7697 * 1.5 Мб = **12 Гб/с**                  |


Фото для ленты (сохраняем 1 фото на пост):

| Показатель           | Пик                                 | В среднем с учетом сезонности          |
|:---------------|:------------------------------------|:---------------------------------------|
| RPS (write)  | 2 * 10000000 / (7 * 86400) = **33** | 1.33 * 10000000 / (7 * 86400) = **22** |
| RPS (read) | **17526** (как у постов в ленте)    | **11700** (как у постов в ленте)       |
| Traffic (write) | 33 * 600 Кб = **20 Мб/с**           | 22 * 600 Кб = **13 Мб/с**              |
| Traffic (read) | 17526 * 600 Кб = **11 Гб/с**        | 11700 * 600 Кб = **7 Гб/с**            |


Комментарии:

| Показатель           | Пик                                          | В среднем с учетом сезонности                   |
|:---------------|:---------------------------------------------|:------------------------------------------------|
| RPS (write)  | 2 * 10 * 10000000 / 86400 = **2315**         | 1.33 * 10 * 10000000 / 86400 = **1539**         |
| RPS (read) | 2 * (15 * 20 * 10000000) / 86400 = **69444** | 1.33 * (15 * 20 * 10000000) / 86400 = **46181** |
| Traffic (write) | 2315 * 1 Кб = **2.3 Мб/с**                   | 1539 * 1 Кб = **1.5 Мб/с**                      |
| Traffic (read) | 69444 * 1 Кб = **69 Мб/с**                   | 46181 * 1 Кб = **46 Мб/с**                      |

Реакции:

| Показатель           | Пик                                   | В среднем с учетом сезонности           |
|:---------------|:--------------------------------------|:----------------------------------------|
| RPS (write)  | 2 * 50 * 10000000 / 86400 = **11574** | 1.33 * 50 * 10000000 / 86400 = **7697** |
| RPS (read) | **17526** (как у постов в ленте)      | **11700** (как у постов в ленте)        |
| Traffic (write) | 11574 * 24 байт = **278 Кб/с**        | 7697 * 24 байт = **185 Кб/с**           |
| Traffic (read) | 17526 * 24 байт = **421 Кб/с**        | 11700 * 24 байт = **281 Кб/с**          |

---

# Хранение

Расчет требуемого места на дисках в среднем за год:
- Фото для постов (оригинал): `86400 * 365 * 330 Мб/с = 10 Пб`
- Фото для постов (формат для ленты): `86400 * 365 * 13 Мб/с = 410 Тб`
- Метаинформация для постов: `86400 * 365 * 44 Кб/с = 1.4 Тб`
- Комментарии: `86400 * 365 * 1.5 Мб/с = 47 Тб`
- Реакции (хранится общее количество реакций на пост): `86400 * 22 * 16 байт = 30 Мб`
- Данные пользователей: `10000000 * 500 байт = 5 Гб`

### Blob-storage

Так как объем данных с фото для постов огромен, то хранить его можно только в blob-storage, например **Amazon S3**

Разделяем данные на горячие и холодные:
- Горячими считаем данные за последние 7 дней `(7 * 28 Тб в день = 196 Тб)`. 
- Холодные данные храним на HDD дисках, горячие - на SSD.
- Данные постепенно переносятся с SSD на HDD и для последнего это является единственным типом операции записи
- Считаем что только **10% запросов уходит к холодным данным, т.е на HDD**

Расчеты для холодных данных:
- Disks_for_capacity = `(10000 + 410 - 196) / 32 Тб = 320`
- Disks_for_throughput = `0.1 * (12000 + 7000) / 100 Мб/с = 19`
- Disks_for_iops = `0.1 * (7697 + 11700) / 100 = 20`
- Результат: 1.2 * 320 = **384 HDD дисков по 32 Тб**

Расчеты для горячих данных:
- Disks_for_capacity = `196 Тб / 100 Тб = 2`
- Disks_for_throughput = `0.9 * (12000 + 7000) / 500 Мб/с = 34`
- Disks_for_iops = `0.9 * (7697 + 11700) / 1000 = 18`
- Disks = 1.2 * 34 = **40 SSD дисков по 100 Тб**

### Реляционная БД

Так как большая часть сущностей у нас имеют определенные логические связи, а объем их данных не настолько велик, то к ним удобно применить реляционную модель. В качестве СУБД предлагаю использовать **Postgres**, которая кроме того обладает удобным механизмом для поиска по гео меткам

В реляционной СУБД храним:
- данные пользователей
- метаданные постов
- комментарии к постам

Примерный расчет дисков:
Disks_for_iops = `(33 + 17526 + 2315 + 69444) / 100 = 893 (HDD), 89 (SSD)`

- Видно, что большая часть нагрузки ложится на чтение комментариев, поэтому выделяем под них отдельную БД
- Общий RPS не позволяет нам использовать Postgres как единственное хранилище данных, поэтому предлагаю и в этом случае разделить данные на горячие и холодные:
  - Холодные данные храним на SSD дисках, горячие - в кэше (описан в следующем разделе)
  - Данные записываются в кэш параллельно записи в Postgres, например через брокер сообщений
  - Считаем что только **10% запросов уходит к холодным данным**

Ниже расчет **только холодных** данных

Расчеты для комментариев:
- Disks_for_capacity = `(2 + 47) / 100ТБ = 1`
- Disks_for_throughput = `69 / 500 Мб/с = 1`
- Disks_for_iops = `(0.1*69444) / 1000 = 7`
- Результат: 1.2 * 7 = **9 SSD дисков 50 Тб**

Расчеты для метаданных постов и пользователей:
- Disks_for_capacity = `(2 + 47) / 100ТБ = 1`
- Disks_for_throughput = `(35 + 3) / 500 Мб/с = 1`
- Disks_for_iops = `(33 + 0.1*17526 + 2315) / 1000 = 5`
- Результат: 1.2 * 5 = **6 SSD дисков 50 Тб**

### Кэш

Кандидаты на in-memory хранение:
- реакции, т.к данные по ним агрегируются в небольшой объем памяти, но при этом сама операция является довольно частой
- горячие данные из Postgres:
  - Посты за последние 7 дней
  - Комментарии к постам, которые были прокомментированы за последние 7 дней

В качестве хранилища хорошо подходит **Redis в режиме AOF**, для персистентного хранения. В этом случае помимо дисков нам нужно рассчитать количество оперативной памяти. Будем считать что для хранения 1 мб данных, в Redis нужно 1.5 мб оперативной памяти

Расчет оперативной памяти (в год):
- реакции: `1.5 * 30 Мб = 45 Мб`
- метаинформация для постов: `1.5 * 7 * 1.4 Тб / 365 = 40 Гб `
- комментарии: `1.5 * 7 * 47 Тб / 365 = 1.4 Тб `
- Всего: 1.2 * 1.5 = **1.8 Тб ОЗУ**

Расчет дисков (SSD nVME):
- Disks_for_capacity = `1.5 / 30 Тб = 1`
- Disks_for_throughput = `(35 + 3 + 69) / 3000 Мб/с = 1`
- Disks_for_iops = `(33 + 0.9*17526 + 2315 + 0.9*69444) / 10000 = 8`
- Результат: 1.2 * 8 = **10 SSD nVME дисков по 4 Тб**

### Обобщенная схема данных

<img src="/assets/storage_schema.png">